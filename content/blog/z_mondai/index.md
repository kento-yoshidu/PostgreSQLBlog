---
title: "問題"
postdate: "2023-04-09"
update: "2023-04-09"
seriesName: "ハンズオンPostgreSQL"
seriesSlug: "HandsOnPostgreSQL"
tags: ["PostgreSQL", "Docker"]
keywords: ["PostgreSQL", "Database", "DB", "Docker"]
published: false
---

# 重要度4

## G1.2 運用管理用コマンド全般

## 各種知識

コミットは(WALバッファー)の内容を(WALファイル)に書き出すことをいう。

チェックポイントは(WALファイル)の内容を(データファイル)に書き出すことをいう。

### GUCパラメーター

PostgreSQLの再起動が必要なのは(①)。マスタープロセスにSIGHUPシグナルを送信する必要があるのは(②)。スーパーユーザーのSETコマンドで変更できるのは(③)。一般ユーザーのSETコマンドで変更できるのは(④)。


|パラメーター|説明|context|
|:--:|---|:---:|
| ⑤ |ログ収集を行うか| ⑥ |
| ⑦ |ログの出力先| ⑧ |
| ⑨ |ログメッセージの行頭の形式指定| ⑩ |
| ⑪ |ログに書き込むレベル| ⑫ |
| ⑬ |クライアントの接続情報を書き込むかどうか| ⑭ |
| ⑭ |WALデータに対して割り当てられる共有メモリーのサイズ|postmaster|
| ⑮ |文の経過時間を出力する|superuser|

log_min_messageのデフォルトは(WARNING)である。

wal_levelパラメーター



#### max_paralell_maintenance_wockers

単一のユーティリティコマンドで使用されるパラレルワーカーの最大数

#### pg_isready

|戻り値|説明|
|---|---|
|0|接続を受け付けている|
|1|接続拒否|
|2|応答がない|
|3|エラー|

### バックアップの種類

pg_dump、pg_dumpallは(①)バックアップに分類される。tar/rsyncなどのコマンドによるバックアップは（②）バックアップに分類される。

pg_dumpは(③)や(④)を指定できる。

### PITR

PITRを行うため、WALに書き込む内容を設定する(①)を(②)もしくは(③)にすること、WALアーカイブを保存するかを設定する(④)を(⑤)にすることが必要。なお、(④)はデフォルトで(⑤)になっている。

参考 : [いつかDBがぶっ壊れるその日まで~ポイントインタイムリカバリ~ | 株式会社ロジカルスタジオ](https://www.wantedly.com/companies/logical-studio/post_articles/287569)

### pg_basebackup

pg_basebackupコマンドは(物理オンラインバックアップ)である。(recovery_target)パラメーターでどこのポイントを復元するかを選択することができる。対象は(DBクラスター全体)である。また、リモートで実行(できる)。

必ず(-D)で出力先を指定する必要がある。

## pg_dump

データベースを指定する。

## pg_dumpall

データベースクラスター全体をバックアップします。また、出力形式は(text)です。そのため、(restore)コマンドではリストアーできないことになります。

### その他コマンド

CLUSTERは(①)の並び順を適切に配置しなおす。

VACUUMは(②)と(③)を処理する。


## pg_stat_activity

|列名|説明|
|---|---|
|datid|バックエンドが接続するDBのOID|
|pid|バックエンドのプロセスID|
|client_port|クライアントがバックエンドとの通信に使用するポート番号|
| ① |トランザクションが開始した時刻|
| ② | stateの最終変更時刻|


|問|答|
|---|---|
| ① |xact_start|
| ② |state_change|

## pg_stat_archiver

|列名|説明|
|---|---|
|archived_count|アーカイブに成功したWALファイルの数|
| ① |アーカイブに成功した**最後の**WALファイルの名前|
|last_archive_time|最後に成功したアーカイブの時刻|
|failed_count|アーカイブに失敗した回数|
| ② |最後に失敗したアーカイブの時刻|
|last_failed_wal|アーカイブに失敗した最後のWALファイルの名前|
|stats_reset|統計情報がリセットされた時刻|

|問|答|
|---|---|
|①|last_archived_wal|
|②|last_failed_Time|

## pg_stat_bgwriter

クラスターの（①）に関するデータを保持します。形式は（②）です。

|列名|説明|
|---|---|
|

|問|説明|
|---|---|
|①|グローバルデータ|
|②|1行のみ|

## pg_statio_all_tables

データベースのテーブルのI/Oに関するデータを保持します。形式は（①）です。

|問|説明|
|---|---|
|①|テーブルごとに1行|

## pg_stat_index

## pg_stat_tuple

## VACUUM

対象の(テーブル)を指定できるが、市内しなかった場合は全てのテーブル、マテリアライズドビューが対象になる。

VACUUM FULLは排他ロックを取得し、未使用領域をOSに返却します。

## vacuumdb

|オプション|説明|
|---|---|
|-f, --full|不要領域を削除する|
|-F, --freeze|行を凍結する|
|-v, --verbose|詳細情報の表示|
|-z, --analyze|統計情報の出力|
|-Z, --analyze-only|情景情報の出力のみで、バキュームを行わない|

## ANALYZE

テーブルを指定しなかった場合、全てのテーブル/行を解析する。

## CLUSTER

インデックスの並び順を配置しなおす。